{
  "name": "Agendamento Completo com MySQL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-webhook",
        "options": {}
      },
      "name": "Webhook IN",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -2064,
        176
      ],
      "webhookId": "whatsapp-webhook",
      "id": "fbd7e3ac-4b78-47da-b29e-8166384c377d"
    },
    {
      "parameters": {
        "functionCode": "return [{json:{telefone:$json.body.From, mensagem:$json.body.Body?.trim().toLowerCase(), to:$json.body.To}}];"
      },
      "name": "Extrair Dados WhatsApp",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1872,
        176
      ],
      "id": "79bfde76-0a5f-46d5-99a9-b40547503de7"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select * from conversas\nwhere telefone = '{{ $json.telefone }}';"
      },
      "name": "Buscar Estado",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 1,
      "position": [
        -1696,
        176
      ],
      "id": "a529ff41-b847-440e-a24a-d7735e2b6632",
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json}}",
              "operation": "isEmpty"
            }
          ]
        }
      },
      "name": "Usu√°rio Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1536,
        176
      ],
      "id": "c02fb65a-69cc-4976-a1e9-9da97b0c4157"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "insert into conversas (telefone, estado)\nvalues ('{{ $('Extrair Dados WhatsApp').item.json.telefone }}', 'menu');"
      },
      "name": "Criar Novo Usu√°rio",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 1,
      "position": [
        -1360,
        -16
      ],
      "id": "7adfc9ff-f8c1-4b15-93eb-5b62332f2455",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "calendar": "primary",
        "start": "={{ $('Transforma√ß√£o de dadoss').item.json.data_google_calendar_start }}",
        "end": "={{ $('Transforma√ß√£o de dadoss').item.json.data_google_calendar_end }}",
        "additionalFields": {
          "sendUpdates": "all",
          "summary": "=Consulta {{ $('Transforma√ß√£o de dadoss').item.json.nome }} {{ $('Transforma√ß√£o de dadoss').item.json.to }}"
        }
      },
      "name": "Criar Evento Google Calendar",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1,
      "position": [
        816,
        368
      ],
      "id": "302a7e32-4462-4148-827c-662dd7eb893f",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Dados WhatsApp').item.json.to }}",
        "to": "={{ $('Extrair Dados WhatsApp').item.json.telefone }}",
        "message": "Ol√° üëã! Eu sou o assistente virtual.\nEscolha uma op√ß√£o:\n1Ô∏è‚É£ - Agendar consulta\n2Ô∏è‚É£ - Tirar d√∫vidas\n3Ô∏è‚É£ - Cancelar agendamento\n\nPara voltar a este menu durante o atendimento, basta enviar \"menu\", \"voltar\" ou \"retornar\".",
        "options": {}
      },
      "name": "Enviar Menu Inicial",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -1216,
        -16
      ],
      "id": "ccd17320-a1ec-48ac-a300-0375fa0bc734",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "return [{json:{estado: $json.estado, telefone: $('Extrair Dados WhatsApp').item.json.telefone, mensagem: $('Extrair Dados WhatsApp').item.json.mensagem, to: $('Extrair Dados WhatsApp').item.json.to}}];"
      },
      "name": "Extrair Estado Atual",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1344,
        192
      ],
      "id": "5adae11e-8d31-41fb-9831-48c008bd2aae"
    },
    {
      "parameters": {
        "from": "={{$json.to}}",
        "to": "={{$json.telefone}}",
        "message": "=Trabalhamos de segunda-feira √† sexta-feira, das 08:00 √†s 18:00.\nPor favor, digite seu nome, data e hor√°rio que deseja reservar.",
        "options": {}
      },
      "name": "Pedir nome e data",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -592,
        -480
      ],
      "id": "836118d7-532d-4e94-a0d1-444fa9b1aba9",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update conversas\nset estado = 'agendamento'\nwhere telefone = '{{ $('Extrair Estado Atual').item.json.telefone }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -416,
        -480
      ],
      "id": "59e0a5b7-1608-4e5d-8774-ecad87143103",
      "name": "Mudar estado para agendamento",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "172934af-0ad5-4bfd-bdc7-b79ad0a7216b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "iniciar agendamento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f1b96e06-7c04-4cfd-ae2d-9fdc3f0acf00",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "agendar",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "iniciar agendamento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e97a6ee4-b2c5-4cf5-a2f1-7f1817646784",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "enviar duvidas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "88aa86ed-d571-4ec6-8e7d-47d5759c33bf",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "duvida",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "enviar duvidas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e10c0678-68bf-4094-9c12-af9894adab68",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "d√∫vida",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "enviar duvidas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "25431c5d-31ab-44d0-9f47-97c0f70271fb",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "iniciar cancelamento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "13a65774-ece6-473a-8fea-732562dd9249",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "cancelar",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "iniciar cancelamento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c2eb8c-e40e-41bb-a300-f9f41a71514c",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "default"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -880,
        -320
      ],
      "id": "9e5487e7-084c-4148-997c-4b53dded41df",
      "name": "Sair menu"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "agendamento",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ca8202e9-78ca-480a-9531-4739615a6ebd"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agendamento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ea02a078-c7e4-4961-bff8-2857949c8271",
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "faq",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "faq"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1fada238-40d4-4ee2-b2ad-49ae7d7adf5c",
                    "leftValue": "={{ $json.estado }}",
                    "rightValue": "cancelamento",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelamento"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -640,
        688
      ],
      "id": "2d2f9bd9-2788-4193-8aae-5c74eb2afae5",
      "name": "Op√ß√µes estados"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0e7bfae9-4d6f-4ab4-bc87-18ff5fedee51",
              "leftValue": "={{ $json.estado }}",
              "rightValue": "menu",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1152,
        192
      ],
      "id": "a173d3f8-7959-4e44-b175-e34c32228302",
      "name": "If estado menu"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© um assistente de agendamento.\nTrabalhamos de segunda-feira √† sexta-feira, das 08:00 √†s 18:00.\nHoje √© {{ $now.toISO() }} (fuso hor√°rio de S√£o Paulo).\n\nExtraia o nome da pessoa e a data/hora da mensagem abaixo. Caso n√£o haja nome para extrair, deixe uma string vazia.\nA data deve ser convertida para o formato ISO 8601 (YYYY-MM-DDTHH:MM:SS-03:00).\n\nResponda SOMENTE com um JSON no formato:\n{\n  \"nome\": \"...\",\n  \"data\": \"...\",\n  \"dataOk\": \"...\"\n}\n\nA propriedade \"dataOk\" deve ser preenchida com valor booleano. 'true' se a data extra√≠da estiver dentro do dia da semana e hor√°rio em que trabalhamos, e 'false' se estiver fora.\n\nMensagem: {{ $json[\"mensagem\"] }}",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -432,
        672
      ],
      "id": "83ae222e-315b-4e94-bd7c-906201a77468",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -432,
        832
      ],
      "id": "be938520-0071-446e-884b-92f679d6000d",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "Ig7oq7pctKGz7cqE",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update conversas\nset estado = \"menu\",\nwhere telefone = \"{{ $('Extrair Dados WhatsApp').item.json.telefone }}\";",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        1392,
        368
      ],
      "id": "d9aeab29-9d92-4f51-89f3-a7ffbcac3c3d",
      "name": "retornar estado menu",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Dados WhatsApp').item.json.to }}",
        "to": "={{ $('Extrair Dados WhatsApp').item.json.telefone }}",
        "message": "Ol√° üëã! Eu sou o assistente virtual.\nEscolha uma op√ß√£o:\n1Ô∏è‚É£ - Agendar consulta\n2Ô∏è‚É£ - Tirar d√∫vidas\n3Ô∏è‚É£ - Cancelar agendamento\n\nPara voltar a este menu durante o atendimento, basta enviar \"menu\", \"voltar\" ou \"retornar\".",
        "options": {}
      },
      "name": "Enviar Menu Inicial1",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -592,
        64
      ],
      "id": "56a21672-e120-4e2c-afbc-82cadd5b73a1",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "resource": "calendar",
        "calendar": {
          "__rl": true,
          "value": "mateussmesquita@gmail.com",
          "mode": "list",
          "cachedResultName": "mateussmesquita@gmail.com"
        },
        "timeMin": "={{ $('Transforma√ß√£o de dadoss').item.json.data_google_calendar_start }}",
        "timeMax": "={{ $('Transforma√ß√£o de dadoss').item.json.data_google_calendar_end }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        432,
        544
      ],
      "id": "db9e83b5-cefc-42a9-bb24-7219a167162b",
      "name": "Get availability in a calendar",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "mateussmesquita@gmail.com",
          "mode": "list",
          "cachedResultName": "mateussmesquita@gmail.com"
        },
        "returnAll": true,
        "timeMin": "={{ $json.after }}",
        "timeMax": "={{ $json.before }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1200,
        736
      ],
      "id": "caef0c2e-288a-4d0a-9e80-97e3a1ab4d69",
      "name": "Get many events",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let originalDate = $('Transforma√ß√£o de dadoss').first().json.data_google_calendar_start;\n\nlet startOfDay = new Date(originalDate);\nconsole.log(startOfDay);\nstartOfDay.setUTCHours(0, 0, 0, 0);\n\nlet endOfDay = new Date(originalDate);\nendOfDay.setUTCDate(endOfDay.getUTCDate() + 1);\nendOfDay.setUTCHours(0, 0, 0, 0);\n\nreturn [\n  {\n    \"json\": {\n      \"after\" : startOfDay.toISOString(),\n      \"before\": endOfDay.toISOString()\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        736
      ],
      "id": "dd7da1c7-99e8-4953-9160-14115fc29e01",
      "name": "Transforma√ß√£o de Dados"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 10,
              "unit": "minutes"
            }
          ]
        },
        "calendarId": {
          "__rl": true,
          "value": "mateussmesquita@gmail.com",
          "mode": "list",
          "cachedResultName": "mateussmesquita@gmail.com"
        },
        "triggerOn": "eventCreated",
        "options": {
          "matchTerm": "Consulta"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTrigger",
      "typeVersion": 1,
      "position": [
        864,
        544
      ],
      "id": "34a2cdf8-77a9-4c56-97a5-1f49bf7106ca",
      "name": "Google Calendar Trigger",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.creator.email }}",
        "subject": "={{ $json.summary }}",
        "emailType": "text",
        "message": "={{ $json.start.dateTime }}",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1072,
        544
      ],
      "id": "bfbdcf8c-7ae1-473d-a676-579368d4b073",
      "name": "Send a message",
      "webhookId": "d5bb4bea-d29b-41f8-98a1-bd986651d69d",
      "credentials": {
        "gmailOAuth2": {
          "id": "Fr4rZg5pXAZCt6k4",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© um assistente de agendamento.\nEsses s√£o os eventos j√° marcados no dia:\n\n{{ JSON.stringify($json[\"eventos\"], null, 2) }}\n\nCom base nesses eventos, indique hor√°rios alternativos ainda est√£o livres no mesmo dia (entre 08:00 e 18:00, no fuso hor√°rio de S√£o Paulo). Como as consultas duram em m√©dia 1 hora, indique os hor√°rios livres que em dentro de 1 hora n√£o haver√° conflito com outros eventos.\nResponda apenas como se estivesse respondendo diretamente ao cliente (sem conter frases como \"Claro! Aqui est√° a resposta para o cliente\"), com uma frase simples explicando que o hor√°rio que ele pediu j√° se encontra agendado e informando quais intervalos de tempo est√£o dispon√≠veis para agendamento, e tamb√©m avise para o cliente enviar a pr√≥xima mensagem contendo a data e hor√°rio escolhido para agendamento. O nome do cliente √© {{ $('Consultar nome').item.json.nome }}. A primeira palavra de sua resposta deve ser o nome do cliente caso for informado, se n√£o, omita isso e continue com o restante da frase normalmente.",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1552,
        736
      ],
      "id": "b94755e9-7ccc-4363-90a2-757e3803b86f",
      "name": "Basic LLM Chain1"
    },
    {
      "parameters": {
        "modelName": "models/gemini-pro-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1552,
        896
      ],
      "id": "11638dd7-12bf-47a7-9acc-52bfde066188",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "Ig7oq7pctKGz7cqE",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "from": "={{ $('Transforma√ß√£o de dadoss').first().json.telefone }}",
        "to": "={{ $('Transforma√ß√£o de dadoss').first().json.to }}",
        "message": "={{ $json.text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        1856,
        736
      ],
      "id": "fe81c0b1-d951-4644-af5e-d9e7b7b52871",
      "name": "Hor√°rios alternativos",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update conversas\nset estado = 'menu' , historico = null\nwhere telefone = '{{ $('Extrair Estado Atual').item.json.telefone }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -464,
        432
      ],
      "id": "cfff9279-aa7c-49c4-bfe5-294fe6d094f8",
      "name": "Retornar ao menu",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Dados WhatsApp').item.json.to }}",
        "to": "={{ $('Extrair Dados WhatsApp').item.json.telefone }}",
        "message": "Ol√° üëã! Eu sou o assistente virtual.\nEscolha uma op√ß√£o:\n1Ô∏è‚É£ - Agendar consulta\n2Ô∏è‚É£ - Tirar d√∫vidas\n3Ô∏è‚É£ - Cancelar agendamento\n\nPara voltar a este menu durante o atendimento, basta enviar \"menu\", \"voltar\" ou \"retornar\".",
        "options": {}
      },
      "name": "Enviar Menu Inicial2",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -640,
        432
      ],
      "id": "683a047f-c189-4933-9ed2-4fec0e71ce56",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "08e37ee4-b4d4-4290-93e2-d1f7f9ec8d21",
              "leftValue": "={{ $('Extrair Dados WhatsApp').item.json.mensagem }}",
              "rightValue": "menu",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "6d27df10-1b90-498d-88b2-f41c5d78e747",
              "leftValue": "={{ $('Extrair Dados WhatsApp').item.json.mensagem }}",
              "rightValue": "voltar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "f5c2cb8f-b9d5-47a5-9139-a01bebf6a84f",
              "leftValue": "={{ $json.mensagem }}",
              "rightValue": "retornar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -912,
        560
      ],
      "id": "87961ed2-f414-4680-88ea-7d32c9b1f343",
      "name": "If voltar menu"
    },
    {
      "parameters": {
        "jsCode": "// Pega todos os eventos retornados\nconst eventos = $input.all().map(item => item.json);\nconsole.log(eventos)\n// Garante que o modelo receba uma lista limpa e simples\nconst listaEventos = eventos.map(e => ({\n  summary: e.summary,\n  start: e.start?.dateTime,\n  end: e.end?.dateTime\n}));\n\n// Retorna tudo como um √∫nico item JSON\nreturn [{\n  json: {\n    eventos: listaEventos\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1376,
        736
      ],
      "id": "0fea4ea4-ee89-472f-9436-be2c75e6604e",
      "name": "Juntando em um elemento"
    },
    {
      "parameters": {
        "jsCode": "let output = $input.first().json.text || '';\noutput = output\n  .replace(/```json/i, '')\n  .replace(/```/g, '')\n  .trim();\nconst dados = JSON.parse(output);\n\nfunction capitalizeEachWord(sentence) {\n  return sentence.split(' ').map(word => {\n    if (word.length === 0) { // Handle empty strings if any\n      return '';\n    }\n    return word.charAt(0).toUpperCase() + word.slice(1);\n  }).join(' ');\n}\n\nconst dataInicial = new Date(dados.data).toISOString();\n\nlet dataFinal = new Date(dados.data);\ndataFinal.setHours(dataFinal.getHours() + 1);\n\n\nconst dataStart = new Date(dados.data);\nconst formatador = new Intl.DateTimeFormat('pt-BR', {\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit',\n  timeZone: 'America/Sao_Paulo'\n});\nconst dataFormatada = formatador.format(dataStart).replace(',', '');\n\nconst dataFormatadaMYSQL = new Date(dados.data).toISOString().replace('T', ' ').slice(0,19)\n\nreturn [{\n  json: {\n    nome: capitalizeEachWord(dados.nome) || $('Buscar Estado').first().json.nome,\n    dataOk: dados.dataOk,\n    data_google_calendar_start: dataInicial,\n    data_google_calendar_end: dataFinal.toISOString(),\n    data_a_exibir: dataFormatada,\n    data_mysql: dataFormatadaMYSQL,\n    telefone: $('Extrair Dados WhatsApp').first().json.to,\n    to: $('Extrair Dados WhatsApp').first().json.telefone\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -128,
        672
      ],
      "id": "74e76cfe-5b7f-4f99-9946-3c71b9910bf6",
      "name": "Transforma√ß√£o de dadoss"
    },
    {
      "parameters": {
        "from": "={{ $json.to }}",
        "to": "={{ $json.telefone }}",
        "message": "Ok! Me conte quais s√£o suas d√∫vidas.",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -592,
        -320
      ],
      "id": "62180c7d-9de1-44c2-b72b-ffe325d1dc02",
      "name": "Iniciar duvidas",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update conversas\nset estado = \"faq\"\nwhere telefone = \"{{ $('Extrair Estado Atual').item.json.telefone }}\";",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -416,
        -320
      ],
      "id": "824f0282-8730-4a6a-916f-10294c684590",
      "name": "Mudar estado para faq",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select historico\nfrom conversas\nwhere telefone = \"{{ $json.telefone }}\";",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -432,
        1056
      ],
      "id": "e0f44f24-2261-4ffd-bd03-cfd7d4e42931",
      "name": "Buscar historico de conversas",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© um assistente virtual de atendimento no WhatsApp para um escrit√≥rio de advocacia criminal.\nResponda de forma informativa √†s d√∫vidas do cliente ({{ $('Buscar Estado').item.json.nome }}). N√£o indique t√©rmino da conversa nas suas respotas, deixe claro que caso houver mais d√∫vidas o cliente pode perguntar. Se j√° consta hist√≥rico da conversa no JSON, n√£o precisa come√ßar sua respota com cumprimento.\nUse o contexto da conversa abaixo para entender a pergunta atual.\n\nHist√≥rico da conversa em JSON:\n{{ JSON.stringify($json[\"historico\"], null, 2) }}\n\nPergunta/mensagem mais recente:\n{{ $('Extrair Dados WhatsApp').item.json.mensagem }}",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -224,
        1056
      ],
      "id": "ac62e3a4-ea01-4260-b008-c9569a90d6c2",
      "name": "Basic LLM Chain2"
    },
    {
      "parameters": {
        "modelName": "models/gemini-flash-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -224,
        1232
      ],
      "id": "9fe5b287-38dd-4aca-a2cc-69feb8231c44",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "Ig7oq7pctKGz7cqE",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const historico = $('Buscar historico de conversas').first().json.historico ? $('Buscar historico de conversas').first().json.historico : [];\nhistorico.push({ 'role': 'user', 'content': $('Extrair Dados WhatsApp').first().json.mensagem }, { 'role': 'assistant', 'content': $input.first().json.text});\nreturn [\n  {\n    \"json\": {\n      \"historico\": JSON.stringify(historico)\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        1056
      ],
      "id": "cac55524-b9e4-4f92-84f0-f91324e1b885",
      "name": "Adicionar msg ao historico"
    },
    {
      "parameters": {
        "operation": "update",
        "table": {
          "__rl": true,
          "value": "conversas",
          "mode": "list",
          "cachedResultName": "conversas"
        },
        "dataMode": "defineBelow",
        "columnToMatchOn": "telefone",
        "valueToMatchOn": "={{ $('Extrair Estado Atual').item.json.telefone }}",
        "valuesToSend": {
          "values": [
            {
              "column": "historico",
              "value": "={{ $json.historico }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        288,
        1056
      ],
      "id": "32cc4128-64b9-46ab-909b-da19c2b1935a",
      "name": "Update rows in a table",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Estado Atual').item.json.to }}",
        "to": "={{ $('Extrair Estado Atual').item.json.telefone }}",
        "message": "={{ $('Basic LLM Chain2').item.json.text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        496,
        1056
      ],
      "id": "8237a272-a137-4fab-91cd-7f798ca20648",
      "name": "Enviar msg da IA",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "table": {
          "__rl": true,
          "value": "conversas",
          "mode": "list",
          "cachedResultName": "conversas"
        },
        "dataMode": "defineBelow",
        "columnToMatchOn": "telefone",
        "valueToMatchOn": "={{ $('Extrair Estado Atual').first().json.telefone }}",
        "valuesToSend": {
          "values": [
            {
              "column": "estado",
              "value": "cancelamento"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        144,
        -256
      ],
      "id": "e06a31cd-8821-4bb2-809d-45923a816967",
      "name": "Mudar estado para cancelamento",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "if (Object.keys($input.item.json).length == 0) {\n  return {\"json\": {}}\n}\n\nconst dataISO = new Date($json.start.dateTime)\n\nreturn {\"json\": {\n  \"data\": dataISO.toLocaleString('pt-BR', {\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit',\n  hour12: false,\n  timeZone: 'America/Sao_Paulo'\n})\n}}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        -128
      ],
      "id": "39ff7b09-4840-4571-b3cd-bb0aef2e2bf8",
      "name": "Formatar data para envio"
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Dados WhatsApp').item.json.to }}",
        "to": "={{ $('Extrair Dados WhatsApp').item.json.telefone }}",
        "message": "=Encontrei as seguintes datas marcadas para seu n√∫mero {{ $('Extrair Dados WhatsApp').item.json.telefone.slice(9) }}:\n\n{{ $input.all().map((item, index) => `${index +1 } - ${item.json.data}`).join('\\n') }}\n\nQual data deseja cancelar?\nResponda apenas com o primeiro n√∫mero.",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -48,
        -256
      ],
      "id": "8a0a8535-c404-498d-b958-5825a1b0388a",
      "name": "Enviar datas para cancelar",
      "executeOnce": true,
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "mateussmesquita@gmail.com",
          "mode": "list",
          "cachedResultName": "mateussmesquita@gmail.com"
        },
        "returnAll": true,
        "timeMax": "={{ $now.plus({ month: 1 }) }}",
        "options": {
          "query": "={{ $json.telefone }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -592,
        -128
      ],
      "id": "de433171-c536-41a1-a482-c68c48f9a18f",
      "name": "Get many events1",
      "alwaysOutputData": true,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "content": "tenho q atualizar coluna status da nova tabela ao cancelar e enviar email tbm pro dono avisando tbm\n\n\ntbm tenho q enviar msg para relembrar clientes de consultas\n\ne tbm adicionar op√ß√£o de reagendar",
        "height": 240,
        "width": 256
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1072,
        1568
      ],
      "typeVersion": 1,
      "id": "ef31a076-0985-4c7a-a62d-fa814380ac73",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8722e0d2-372a-4a61-9526-1c731e09d90f",
              "leftValue": "={{ $('Transforma√ß√£o de dadoss').item.json.dataOk }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        224,
        672
      ],
      "id": "980dadeb-4389-48ef-a3e7-b92898e40d77",
      "name": "se data dentro horario de trabalho"
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Estado Atual').item.json.to }}",
        "to": "={{ $('Extrair Estado Atual').item.json.telefone }}",
        "message": "=Desculpe {{ $json.nome }}, mas n√£o trabalhamos neste hor√°rio que voc√™ escolheu.\nTrabalhamos de segunda-feira √† sexta-feira, das 08:00 √†s 18:00.\nPor favor, envie uma nova mensagem com um hor√°rio v√°lido.",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        432,
        784
      ],
      "id": "9c55d1ba-4517-4e81-a4eb-478528416bf8",
      "name": "Enviar horarios validos",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "eabece7f-6ad2-4b07-a92e-d60743013a35",
              "leftValue": "={{ $json.available }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        608,
        544
      ],
      "id": "3dfa2e6a-d986-42e7-827a-ac2585189bab",
      "name": "Se disponivel"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update conversas\nset nome = '{{ $json.nome }}'\nwhere telefone = '{{ $('Extrair Dados WhatsApp').item.json.telefone }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        48,
        672
      ],
      "id": "b8f6529b-c6c5-4efc-8e60-63fbc652eea0",
      "name": "Update nome",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select nome\nfrom conversas\nwhere telefone = '{{ $('Extrair Dados WhatsApp').item.json.telefone }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        816,
        736
      ],
      "id": "e3943c39-3ee3-4853-8cf2-3ffaae6afa78",
      "name": "Consultar nome",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "insert into datas_agendadas (conversas_telefone, `data`, evento_id)\nvalues ('{{ $('Extrair Dados WhatsApp').item.json.telefone }}',\n  DATE_SUB('{{ $('Transforma√ß√£o de dadoss').item.json.data_mysql }}', INTERVAL 3 HOUR),\n  '{{ $('Criar Evento Google Calendar').item.json.id }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        1200,
        368
      ],
      "id": "adc0dcc9-f387-4fe2-a799-17e3b8a328e7",
      "name": "Insert into datas_agendadas",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "from": "={{ $('Transforma√ß√£o de dadoss').first().json.telefone }}",
        "to": "={{ $('Transforma√ß√£o de dadoss').first().json.to }}",
        "message": "=‚úÖ Agendamento confirmado!\n{{ $('Transforma√ß√£o de dadoss').first().json.nome }} em {{ $('Transforma√ß√£o de dadoss').first().json.data_a_exibir }}",
        "options": {}
      },
      "name": "Confirmar Agendamento",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        1008,
        368
      ],
      "id": "04f4d93a-10e7-41c2-945e-87611a9a3015",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cc9bb3aa-5a10-4466-8f3b-e457df97e110",
              "leftValue": "={{ $input.item.json }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -256,
        -128
      ],
      "id": "5cb69736-07f8-453f-8ce0-8206b046da20",
      "name": "If tem datas"
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Estado Atual').item.json.to }}",
        "to": "={{ $('Extrair Estado Atual').item.json.telefone }}",
        "message": "=N√£o encontrei nenhuma data marcada para seu n√∫mero {{ $('Extrair Estado Atual').item.json.telefone.split(9) }}.",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        -48,
        0
      ],
      "id": "a9773aca-7841-45fd-a4f8-9b32293544b4",
      "name": "Sem datas",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "mateussmesquita@gmail.com",
          "mode": "list",
          "cachedResultName": "mateussmesquita@gmail.com"
        },
        "returnAll": true,
        "timeMax": "={{ $now.plus({ month: 1 }) }}",
        "options": {
          "query": "={{ $json.telefone }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -432,
        1472
      ],
      "id": "5899c902-4a6a-46b3-a620-1b117f63a338",
      "name": "Get many events2",
      "alwaysOutputData": false,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "mateussmesquita@gmail.com",
          "mode": "list",
          "cachedResultName": "mateussmesquita@gmail.com"
        },
        "eventId": "={{ $json.id }}",
        "options": {
          "sendUpdates": "all"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -64,
        1472
      ],
      "id": "1d909f09-e5f7-4ad1-9d18-ebe0479151c5",
      "name": "Delete an event",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "5zO8YWIhs6oVo5hV",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const dataISO = new Date($input.all()[parseInt($('Extrair Dados WhatsApp').first().json.mensagem) - 1].json.start.dateTime)\n\nreturn [{json: {\n  id: $input.all()[parseInt($('Extrair Dados WhatsApp').first().json.mensagem) - 1].json.id,\n  dataMSG: dataISO.toLocaleString('pt-BR', {\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit',\n  hour12: false,\n  timeZone: 'America/Sao_Paulo'\n})\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -256,
        1472
      ],
      "id": "6167a80a-bcdd-4079-89e1-6f77db6cf57d",
      "name": "Retorna id",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "table": {
          "__rl": true,
          "value": "datas_agendadas",
          "mode": "list",
          "cachedResultName": "datas_agendadas"
        },
        "dataMode": "defineBelow",
        "columnToMatchOn": "evento_id",
        "valueToMatchOn": "={{ $('Retorna id').item.json.id }}",
        "valuesToSend": {
          "values": [
            {
              "column": "status",
              "value": "cancelado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        128,
        1472
      ],
      "id": "637f844f-4f90-4188-a939-c3b1291941cb",
      "name": "Update datas_agendadas",
      "credentials": {
        "mySql": {
          "id": "rI9YA4iOV2Ex03Gc",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "content": "sequ√´ncia caso cliente mande msg errada",
        "height": 240,
        "width": 256
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -384,
        1744
      ],
      "typeVersion": 1,
      "id": "31706628-ecd9-4615-92d2-af49173fae59",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "from": "={{ $('Extrair Dados WhatsApp').first().json.to }}",
        "to": "={{ $('Extrair Dados WhatsApp').first().json.telefone }}",
        "message": "=Sua consulta no dia {{ $('Retorna id').item.json.dataMSG }} foi cancelada com sucesso.\n\nObrigado!",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        336,
        1472
      ],
      "id": "b104f7a3-f458-4167-8937-2bdb8a133144",
      "name": "Cancelamento confirmado",
      "credentials": {
        "twilioApi": {
          "id": "IcxAkoupGujPtEyg",
          "name": "Twilio account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook IN": {
      "main": [
        [
          {
            "node": "Extrair Dados WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados WhatsApp": {
      "main": [
        [
          {
            "node": "Buscar Estado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Estado": {
      "main": [
        [
          {
            "node": "Usu√°rio Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usu√°rio Existe?": {
      "main": [
        [
          {
            "node": "Criar Novo Usu√°rio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extrair Estado Atual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Novo Usu√°rio": {
      "main": [
        [
          {
            "node": "Enviar Menu Inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Evento Google Calendar": {
      "main": [
        [
          {
            "node": "Confirmar Agendamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Estado Atual": {
      "main": [
        [
          {
            "node": "If estado menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pedir nome e data": {
      "main": [
        [
          {
            "node": "Mudar estado para agendamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sair menu": {
      "main": [
        [
          {
            "node": "Pedir nome e data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pedir nome e data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Iniciar duvidas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Iniciar duvidas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Iniciar duvidas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get many events1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get many events1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Menu Inicial1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Op√ß√µes estados": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar historico de conversas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get many events2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If estado menu": {
      "main": [
        [
          {
            "node": "Sair menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If voltar menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Transforma√ß√£o de dadoss",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Menu Inicial1": {
      "main": [
        []
      ]
    },
    "Get availability in a calendar": {
      "main": [
        [
          {
            "node": "Se disponivel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transforma√ß√£o de Dados": {
      "main": [
        [
          {
            "node": "Get many events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many events": {
      "main": [
        [
          {
            "node": "Juntando em um elemento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Calendar Trigger": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain1": {
      "main": [
        [
          {
            "node": "Hor√°rios alternativos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Menu Inicial2": {
      "main": [
        [
          {
            "node": "Retornar ao menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If voltar menu": {
      "main": [
        [
          {
            "node": "Enviar Menu Inicial2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Op√ß√µes estados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Juntando em um elemento": {
      "main": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transforma√ß√£o de dadoss": {
      "main": [
        [
          {
            "node": "Update nome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iniciar duvidas": {
      "main": [
        [
          {
            "node": "Mudar estado para faq",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar historico de conversas": {
      "main": [
        [
          {
            "node": "Basic LLM Chain2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain2": {
      "main": [
        [
          {
            "node": "Adicionar msg ao historico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adicionar msg ao historico": {
      "main": [
        [
          {
            "node": "Update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update rows in a table": {
      "main": [
        [
          {
            "node": "Enviar msg da IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mudar estado para cancelamento": {
      "main": [
        []
      ]
    },
    "Formatar data para envio": {
      "main": [
        [
          {
            "node": "If tem datas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar datas para cancelar": {
      "main": [
        [
          {
            "node": "Mudar estado para cancelamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many events1": {
      "main": [
        [
          {
            "node": "Formatar data para envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "se data dentro horario de trabalho": {
      "main": [
        [
          {
            "node": "Get availability in a calendar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar horarios validos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se disponivel": {
      "main": [
        [
          {
            "node": "Criar Evento Google Calendar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Consultar nome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update nome": {
      "main": [
        [
          {
            "node": "se data dentro horario de trabalho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar nome": {
      "main": [
        [
          {
            "node": "Transforma√ß√£o de Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "retornar estado menu": {
      "main": [
        []
      ]
    },
    "Insert into datas_agendadas": {
      "main": [
        [
          {
            "node": "retornar estado menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Agendamento": {
      "main": [
        [
          {
            "node": "Insert into datas_agendadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If tem datas": {
      "main": [
        [
          {
            "node": "Enviar datas para cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sem datas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many events2": {
      "main": [
        [
          {
            "node": "Retorna id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retorna id": {
      "main": [
        [
          {
            "node": "Delete an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete an event": {
      "main": [
        [
          {
            "node": "Update datas_agendadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update datas_agendadas": {
      "main": [
        [
          {
            "node": "Cancelamento confirmado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "bf80ee25-c23a-43be-a552-45fd10c9e1b5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "cb109072c7e3897f3d4cd1c2cc4864bc3ba45d5c1d80634c5ee3532b7bdc100f"
  },
  "id": "0wZTN28rsAHoA4JR",
  "tags": []
}