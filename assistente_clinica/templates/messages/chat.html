<div id="messages-container">
    {% for m in mensagens %}
        <div class="mb-2">
            {% if m.tipo == 'cliente' %}
                <div class="bg-gray-200 p-2 rounded max-w-md">{{ m.conteudo }}</div>
            {% else %}
                <div class="bg-blue-600 text-white p-2 rounded max-w-md ml-auto">{{ m.conteudo }}</div>
            {% endif %}
        </div>
    {% endfor %}
</div>

<script>
(function(){
    const room = "{{ conversa.id }}";
    const container = document.getElementById("messages-container");

    function connect() {
        const proto = (window.location.protocol === "https:") ? "wss" : "ws";
        const socket = new WebSocket(proto + "://" + window.location.host + "/ws/chat/" + room + "/");

        socket.onopen = () => console.log("WS open", room);

        socket.onclose = () => {
            console.log("WS closed â€” reconnecting in 1s");
            setTimeout(connect, 1000);
        };

        socket.onerror = (e) => console.error("WS error", e);

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const msg = data.mensagem;
            const tipo = data.tipo;

            const html = tipo === "agente"
              ? `<div class="bg-blue-600 text-white p-2 rounded max-w-md ml-auto mb-2">${msg}</div>`
              : `<div class="bg-gray-200 p-2 rounded max-w-md mb-2">${msg}</div>`;

            container.insertAdjacentHTML("beforeend", html);
            container.scrollTop = container.scrollHeight;
        };
    }

    connect();
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const container = document.getElementById("messages-container");
    container.scrollTop = container.scrollHeight;
});
</script>

<form hx-post="/messages/send/"
      hx-target="#messages-container"
      hx-swap="beforeend"
      class="p-4 border-t bg-white flex">
    {% csrf_token %}
    <input type="hidden" name="conversa_id" value="{{ conversa.id }}">
    <input type="text" name="mensagem"
           class="flex-1 border rounded-lg p-2"
           placeholder="Digite uma mensagem..." />
    <button class="ml-2 bg-blue-600 text-white px-4 py-2 rounded">
        Enviar
    </button>
</form>